---

  - hosts: tag_Name_control_{{ lookup('env', 'DEPLOY') }}

    tasks:

      - name: stop consul
        service:
          name="consul"
          state="stopped"

      - name: clear raft data
        file:
          path="/var/consul/raft"
          state="absent"

      - name: set bootstrap to true
        lineinfile: |
          name="/etc/consul/agent/config.json"
          regexp="^\s+\\"bootstrap\\"*"
          line="  \"bootstrap\": true,"

      #- name: set bootstrap_expect to 3
      #  lineinfile: |
      #    name="/etc/consul/agent/config.json"
      #    regexp="^\s+\\"bootstrap_expect\\"*"
      #    line="  \"bootstrap_expect\": 3,"
      #    insertafter="^\{.*"

      - name: bootstrap consul cluster
        service:
          name="consul"
          state="started"

      - name: settle...
        pause: seconds=15


  - hosts: tag_Name_control_{{ lookup('env', 'DEPLOY') }}

    serial: 1

    tasks:

      - name: stop consul
        service:
          name="consul"
          state="stopped"

      - name: settle...
        pause: seconds=5

      - name: set bootstrap to false
        lineinfile: |
          name="/etc/consul/agent/config.json"
          regexp="^\s+\\"bootstrap\\"*"
          line="  \"bootstrap\": false,"

      #- name: remove bootstrap expect
      #  lineinfile: |
      #    name="/etc/consul/agent/config.json"
      #    regexp="^\s+\\"bootstrap_expect\\"*"
      #    state="absent"

      - name: start consul
        service:
          name="consul"
          state="started"
          enabled="yes"

      - name: settle...
        pause: seconds=5

      - name: restart systemd-resolved
        service:
          name: systemd-resolved
          state: restarted
          
  - hosts: tag_Name_control_{{ lookup('env', 'DEPLOY') }}

    tasks:

      - name: restore consul kv
        service:
          name="consul-restore"
          state="started"
          enabled="yes"
        run_once: yes

      - name: start consul alerts
        service:
          name="consul-alerts"
          state="started"
          enabled="yes"
        run_once: yes
