---

  - hosts: tag_Name_dbconfig_{{ cluster }}_{{ lookup('env', 'DEPLOY') }}

    vars:

      port: 27019
      uri: mongodb-configsvr-{{ cluster }}.service.consul

      config: >
        rs.initiate(
          {
            "_id": "{{ lookup('env', 'IDENTIFIER') }}-{{ lookup('env', 'DEPLOY') }}-{{ cluster }}",
            "configsvr": true,
            "members": [
            {%- for i in range(ansible_play_hosts|count) %}
              { "_id" : {{ i }}, "host" : "control-{{ i + 1 }}:{{ port }}" }
              {%- if loop.index != ansible_play_hosts|count %},{% endif -%}
            {% endfor -%}
            ]
          }
        )

    tasks:

      - name: enable and start mongodb-configsvr service
        service:
          name: mongodb-configsvr
          state: started
          enabled: yes

      - name: wait for mongodb-configsvr consul service
        wait_for:
          host: "{{ uri }}"
          port: "{{ port }}"
          delay: 5

      - name: initialize mongodb-configsvr
        command: mongo {{ uri }}:{{ port }} --eval '{{ config }}'
        register: mongo
        run_once: yes

      - name: print output
        debug:
          msg: "{{ mongo.stdout }}"
        run_once: yes
