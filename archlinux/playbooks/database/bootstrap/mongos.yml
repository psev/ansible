---

  - hosts: tag_Name_database_{{ lookup('env', 'DEPLOY') }}

    vars:

      databases:

        - federal

      collections:

        - federal.bill
        - federal.billstatus

    tasks:

      - name: add shards
        command: mongo mongo-mongos.service.consul:27017 --eval 'sh.addShard("{{ lookup('env', 'IDENTIFIER') }}-{{ lookup('env', 'DEPLOY') }}-shard/mongo-shardsvr.service.consul:27018")'
        run_once: yes

      - name: enable sharding for selected databases
        command: mongo mongo-mongos.service.consul:27017 --eval 'sh.enableSharding("{{ item }}")'
        with_items: "{{ databases }}"
        run_once: yes

      - name: create _id index for selected collections
        command: >
          {% set database = item.split(".")[0] %}
          {% set collection = item.split(".")[-1] %}
          mongo mongo-mongos.service.consul:27017 --eval 'use {{ database }}; db.{{ collection }}.createIndex({ _id: 1 })'
        with_items: "{{ collections }}"
        run_once: yes

      - name: enable sharding for selected collections
        command: >
          mongo mongo-mongos.service.consul:27017 --eval 'sh.shardCollection("{{ item }}", { _id: 1 })'
        with_items: "{{ collections }}"
        run_once: yes
