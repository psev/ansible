---

  - hosts: tag_Name_dbconfig_{{ cluster }}_{{ lookup('env', 'DEPLOY') }}

    vars:

      port: 27017
      uri: mongodb-mongos-{{ cluster }}.service.consul

      shardsvr_replset: "{{ lookup('env', 'IDENTIFIER') }}-{{ lookup('env', 'DEPLOY') }}-{{ cluster }}-{{ shard }}"

      shardsvr_group: tag_Name_dbshard_{{ cluster }}_{{ shard }}_{{ lookup('env', 'DEPLOY') }}

      shardsvr_port: 27018

      shardsvr_hosts: >
        {%- for i in range(groups[shardsvr_group]|count) -%}
          dbshard-{{ cluster }}-{{ shard }}-{{ i + 1 }}:{{ shardsvr_port }}
          {%- if loop.index != groups[shardsvr_group]|count -%},{%- endif -%}
        {%- endfor -%}

      shardsvr_list: "{{ shardsvr_hosts | replace('\n', '') }}"

    tasks:

      - name: enable and start mongo-mongos
        service:
          name: mongodb-mongos
          state: started
          enabled: yes

      - name: wait for mongodb-mongos-primary.service.consul
        wait_for:
          host: "{{ ansible_host }}"
          port: "{{ port }}"
          delay: 10
          timeout: 30

      - name: print shardsvr_list
        debug:
          msg: "{{ shardsvr_list }}"
        run_once: yes

      - name: add shards
        command: >
          mongo {{ uri }}:{{ port }} --eval 'sh.addShard("{{ shardsvr_replset }}/{{ shardsvr_list }}")'
        register: mongo
        run_once: yes

      - name: print output
        debug:
          msg: "{{ mongo.stdout }}"
        run_once: yes
