---

  - hosts: tag_Name_dbconfig_{{ cluster }}_{{ lookup('env', 'DEPLOY') }}

    vars:

      port: 27017
      uri: mongodb-mongos-{{ cluster }}.service.consul

      shard_key: "{ _id: 1 }"
      shard_replset: "{{ lookup('env', 'IDENTIFIER') }}-{{ lookup('env', 'DEPLOY') }}-{{ cluster }}-{{ shard }}"
      shardsvr_uri: mongodb-shardsvr-{{ cluster }}-{{ shard }}.service.consul:27018

      databases:

        - federal

      collections:

        - federal.bill
        - federal.billstatus

    tasks:

      - name: enable and start mongo-mongos
        service:
          name: mongodb-mongos
          state: started
          enabled: yes

      - name: create shard index for selected collections
        command: >
          {% set database = item.split(".")[0] %}
          {% set collection = item.split(".")[-1] %}
          mongo {{ uri }}:{{ port }}/{{ database }} --eval 'db.{{ collection }}.createIndex({{ shard_key }})'
        with_items: "{{ collections }}"
        run_once: yes

      - name: enable sharding for selected databases
        command: mongo {{ uri }}:{{ port }} --eval 'sh.enableSharding("{{ item }}")'
        with_items: "{{ databases }}"
        run_once: yes

      - name: enable sharding for selected collections
        command: >
          mongo {{ uri }}:{{ port }} --eval 'sh.shardCollection("{{ item }}", {{ shard_key }})'
        with_items: "{{ collections }}"
        run_once: yes

      - name: add shards
        command: >
          mongo {{ uri }}:{{ port }} --eval 'sh.addShard("{{ shard_replset }}/{{ shardsvr_uri }}")'
        register: mongo
        run_once: yes

      - name: print output
        debug:
          msg: "{{ mongo.stdout }}"
        run_once: yes
