---

  - hosts: tag_Name_database_{{ lookup('env', 'DEPLOY') }}

    vars:

      name: shardsvr
      port: 27018
      uri: mongo-{{ name }}.service.consul:{{ port }}

      config: >
        rs.initiate(
          {
            "_id": "{{ lookup('env', 'IDENTIFIER') }}-{{ lookup('env', 'DEPLOY') }}-{{ name }}",
            "configsvr": false,
            "members": [
            {%- for i in range(ansible_play_hosts|count) %}
              { "_id" : {{ i }}, "host" : "database-{{ i + 1 }}:{{ port }}" }
              {%- if loop.index != ansible_play_hosts|count %},{% endif -%}
            {% endfor -%}
            ]
          }
        )

    tasks:

      - name: initialize mongo-shardsvr
        command: mongo {{ uri }} --eval '{{ config | replace("\n", "") }}'
        run_once: yes
